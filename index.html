<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>minos-python: The framework which helps you create reactive microservices in Python &mdash; Minos Python  documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link href="_static/style.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="#" class="icon icon-home"> Minos Python
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"><ul>
<li><a class="reference internal" href="#">minos-python: The framework which helps you create reactive microservices in Python</a><ul>
<li><a class="reference internal" href="#summary">Summary</a></li>
<li><a class="reference internal" href="#roadmap">Roadmap</a></li>
<li><a class="reference internal" href="#foundational-patterns">Foundational Patterns</a></li>
<li><a class="reference internal" href="#installation">Installation</a></li>
<li><a class="reference internal" href="#documentation">Documentation</a></li>
<li><a class="reference internal" href="#quickstart">QuickStart</a><ul>
<li><a class="reference internal" href="#set-up-the-environment">Set up the environment</a></li>
<li><a class="reference internal" href="#install-the-dependencies">Install the dependencies</a></li>
<li><a class="reference internal" href="#configure-a-microservice">Configure a Microservice</a></li>
<li><a class="reference internal" href="#create-an-aggregate">Create an Aggregate</a></li>
<li><a class="reference internal" href="#expose-a-command">Expose a Command</a></li>
<li><a class="reference internal" href="#subscribe-to-an-event-and-expose-a-query">Subscribe to an Event and Expose a Query</a></li>
<li><a class="reference internal" href="#interact-with-another-microservice">Interact with another Microservice</a><ul>
<li><a class="reference internal" href="#the-foobar-microservice">The <code class="docutils literal notranslate"><span class="pre">foobar</span></code> Microservice</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#packages">Packages</a><ul>
<li><a class="reference internal" href="#core">Core</a></li>
<li><a class="reference internal" href="#plugins">Plugins</a></li>
</ul>
</li>
<li><a class="reference internal" href="#source-code">Source Code</a></li>
<li><a class="reference internal" href="#getting-help">Getting Help</a></li>
<li><a class="reference internal" href="#discussion-and-development">Discussion and Development</a></li>
<li><a class="reference internal" href="#how-to-contribute">How to contribute</a><ul>
<li><a class="reference internal" href="#create-an-issue">Create an issue</a></li>
<li><a class="reference internal" href="#submit-a-pull-request">Submit a Pull Request</a></li>
</ul>
</li>
<li><a class="reference internal" href="#license">License</a></li>
</ul>
</li>
</ul>
</div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="#">Minos Python</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="#" class="icon icon-home"></a> &raquo;</li>
      <li>minos-python: The framework which helps you create reactive microservices in Python</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/index.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <p align="center">
  <a href="https://minos.run" target="_blank"><img src="https://raw.githubusercontent.com/minos-framework/.github/main/images/logo.png" alt="Minos logo"></a>
</p><section id="minos-python-the-framework-which-helps-you-create-reactive-microservices-in-python">
<h1>minos-python: The framework which helps you create reactive microservices in Python<a class="headerlink" href="#minos-python-the-framework-which-helps-you-create-reactive-microservices-in-python" title="Permalink to this headline"></a></h1>
<a class="reference external image-reference" href="https://pypi.org/project/minos-microservice-common/"><img alt="PyPI Latest Release" src="https://img.shields.io/pypi/v/minos-microservice-common.svg" /></a>
<a class="reference external image-reference" href="https://minos-framework.github.io/minos-python"><img alt="GitHub Workflow Status" src="https://img.shields.io/github/workflow/status/minos-framework/minos-python/pages%20build%20and%20deployment?label=docs" /></a>
<a class="reference external image-reference" href="https://github.com/minos-framework/minos-python/blob/main/LICENSE"><img alt="License" src="https://img.shields.io/github/license/minos-framework/minos-python.svg" /></a>
<a class="reference external image-reference" href="https://codecov.io/gh/minos-framework/minos-python"><img alt="Coverage" src="https://codecov.io/github/minos-framework/minos-python/coverage.svg?branch=main" /></a>
<a class="reference external image-reference" href="https://stackoverflow.com/questions/tagged/minos"><img alt="Stack Overflow" src="https://img.shields.io/badge/Stack%20Overflow-Ask%20a%20question-green" /></a>
<a class="reference external image-reference" href="https://gitter.im/minos-framework/community"><img alt="Gitter" src="https://badges.gitter.im/Join%20Chat.svg" /></a>
<a class="reference external image-reference" href="https://github.com/minos-framework/minos-python"><img alt="Tokei" src="https://tokei.rs/b1/github/minos-framework/minos-python?category=code" /></a>
<section id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Permalink to this headline"></a></h2>
<p>Minos is a framework which helps you create <a class="reference external" href="https://www.reactivemanifesto.org/">reactive</a> microservices in Python. Internally, it leverages Event Sourcing, CQRS and a message driven architecture to fulfil the commitments of an asynchronous environment.</p>
</section>
<section id="roadmap">
<h2>Roadmap<a class="headerlink" href="#roadmap" title="Permalink to this headline"></a></h2>
<p>The roadmap of this project is publicly accessible at this <a class="reference external" href="https://github.com/minos-framework/roadmap">GitHub Repository</a>.</p>
</section>
<section id="foundational-patterns">
<h2>Foundational Patterns<a class="headerlink" href="#foundational-patterns" title="Permalink to this headline"></a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">minos</span></code> framework is built strongly inspired by the following set of patterns:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://microservices.io/patterns/microservices.html">Microservice architecture</a>: Architect an application as a collection of loosely coupled services.</p></li>
<li><p><a class="reference external" href="https://microservices.io/patterns/decomposition/decompose-by-subdomain.html">Decompose by subdomain</a>: Define services corresponding to Domain-Driven Design (DDD) subdomains</p></li>
<li><p><a class="reference external" href="https://microservices.io/patterns/decomposition/self-contained-service.html">Self-contained Service</a>: Microservices can respond to a synchronous request without waiting for the response from any other service.</p></li>
<li><p><a class="reference external" href="https://microservices.io/patterns/data/database-per-service.html">Database per service</a>: Keep each microservice’s persistent data private to that service and accessible only via its API. A service’s transactions only involve its database.</p></li>
<li><p><a class="reference external" href="https://microservices.io/patterns/data/saga.html">Saga</a>: Transaction that spans multiple services.</p></li>
<li><p><a class="reference external" href="https://microservices.io/patterns/data/cqrs.html">CQRS</a>: view database, which is a read-only replica that is designed to support queries that retrieves data from microservice. The application keeps the replica up to date by subscribing to Domain events published by the service that own the data.</p></li>
<li><p><a class="reference external" href="https://microservices.io/patterns/data/domain-event.html">Domain event</a>: A service often needs to publish events when it updates its data. These events might be needed, for example, to update a CQRS view.</p></li>
<li><p><a class="reference external" href="https://microservices.io/patterns/data/event-sourcing.html">Event Sourcing</a>: Event sourcing persists the state of a business entity such an Order or a Customer as a sequence of state-changing events. Whenever the state of a business entity changes, a new event is appended to the list of events. Since saving an event is a single operation, it is inherently atomic. The application reconstructs an entity’s current state by replaying the events.</p></li>
<li><p><a class="reference external" href="https://microservices.io/patterns/communication-style/messaging.html">Messaging</a>: Services communicating by exchanging messages over messaging channels. (Apache Kafka is used in this case)</p></li>
<li><p><a class="reference external" href="https://microservices.io/patterns/apigateway.html">API gateway</a>: Single entry point for all clients. The API gateway proxy/route to the appropriate service.</p></li>
<li><p><a class="reference external" href="https://microservices.io/patterns/service-registry.html">Service registry</a>: Database of services. A service registry might invoke a service instance’s health check API to verify that it is able to handle requests</p></li>
<li><p><a class="reference external" href="https://microservices.io/patterns/self-registration.html">Self Registration</a>: Each service instance register on startup and unregister on stop.</p></li>
<li><p><a class="reference external" href="https://microservices.io/patterns/security/access-token.html">Access token</a>: The API Gateway authenticates the request and passes an access token (e.g. JSON Web Token) that securely identifies the requestor in each request to the services. A service can include the access token in requests it makes to other services.</p></li>
<li><p><a class="reference external" href="https://microservices.io/patterns/observability/health-check-api.html">Health Check API</a>: A service has a health check API endpoint (e.g. HTTP <code class="docutils literal notranslate"><span class="pre">/health</span></code>) that returns the health of the service.</p></li>
</ul>
</section>
<section id="installation">
<h2>Installation<a class="headerlink" href="#installation" title="Permalink to this headline"></a></h2>
<p>The easiest way to manage a project is with the <code class="docutils literal notranslate"><span class="pre">minos</span></code> command-line interface, which provides commands to setup both the project skeleton (configures containerization, databases, brokers, etc.) and the microservice skeleton (the base microservice structure, environment configuration, etc.).</p>
<p>You can install it with:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>pip install minos-cli
</pre></div>
</div>
<p>Here is a summary containing the most useful commands:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">minos</span> <span class="pre">new</span> <span class="pre">project</span> <span class="pre">$NAME</span></code>: Create a new Project</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">minos</span> <span class="pre">set</span> <span class="pre">$RESOURCE</span> <span class="pre">$BACKEND</span></code>: Configure an environment resource (broker, database, etc.).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">minos</span> <span class="pre">deploy</span> <span class="pre">project</span></code>: Deploy a project.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">minos</span> <span class="pre">new</span> <span class="pre">microservice</span> <span class="pre">$NAME</span></code>: Create a new microservice.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">minos</span> <span class="pre">deploy</span> <span class="pre">microservice</span></code> deploy a microservice.</p></li>
</ul>
<p>For more information, visit the <cite>``minos-cli`</cite> &lt;<a class="reference external" href="https://github.com/minos-framework/minos-cli">https://github.com/minos-framework/minos-cli</a>&gt;`_ repository.</p>
</section>
<section id="documentation">
<h2>Documentation<a class="headerlink" href="#documentation" title="Permalink to this headline"></a></h2>
<p>The best place to start learning how to use the Minos Framework is at <a class="reference external" href="https://www.minos.run/learn/">Minos Learn</a>. The official API Reference is publicly available at the <a class="reference external" href="https://minos-framework.github.io/minos-python">GitHub Pages</a>.</p>
</section>
<section id="quickstart">
<h2>QuickStart<a class="headerlink" href="#quickstart" title="Permalink to this headline"></a></h2>
<p>This section includes a quickstart guide to create your first <code class="docutils literal notranslate"><span class="pre">minos</span></code> microservice, so that anyone can get the gist of the framework.</p>
<section id="set-up-the-environment">
<h3>Set up the environment<a class="headerlink" href="#set-up-the-environment" title="Permalink to this headline"></a></h3>
<p>The required environment to run this quickstart is the following:</p>
<ul class="simple">
<li><p>A <code class="docutils literal notranslate"><span class="pre">python&gt;=3.9</span></code> interpreter with version equal or greater to .</p></li>
<li><p>A <code class="docutils literal notranslate"><span class="pre">kafka</span></code> instance available at <code class="docutils literal notranslate"><span class="pre">localhost:9092</span></code></p></li>
<li><p>A <code class="docutils literal notranslate"><span class="pre">postgres</span></code> instance available at <code class="docutils literal notranslate"><span class="pre">localhost:5432</span></code> with the <code class="docutils literal notranslate"><span class="pre">foo_db</span></code> and <code class="docutils literal notranslate"><span class="pre">foobar_db</span></code> databases accessible with the <code class="docutils literal notranslate"><span class="pre">user:pass</span></code> credentials.</p></li>
<li><p>Two TCP sockets available to use at <code class="docutils literal notranslate"><span class="pre">localhost:4545</span></code> and <code class="docutils literal notranslate"><span class="pre">localhost:4546</span></code>.</p></li>
</ul>
<details>
  <summary>Click to show a <code>docker-compose.yml</code> that provides the <code>kafka</code> and <code>postgres</code> instances ready to be used!</summary>

```yaml
# docker-compose.yml
version: "3.9"
services:
  zookeeper:
    restart: always
    image: wurstmeister/zookeeper:latest
  kafka:
    restart: always
    image: wurstmeister/kafka:latest
    ports:
      - "9092:9092"
    depends_on:
      - zookeeper
    environment:
      KAFKA_ADVERTISED_HOST_NAME: localhost
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
  postgres:
    restart: always
    image: postgres:latest
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=pass
```

Then, start the environment:

```shell
docker-compose up
```

To create the databases, just run the following command:

```shell
docker-compose exec postgres psql -U user -tc 'CREATE database foo_db'
docker-compose exec postgres psql -U user -tc 'CREATE database foobar_db'
```
</details><p>Note that these parameters can be customized on the configuration files.</p>
</section>
<section id="install-the-dependencies">
<h3>Install the dependencies<a class="headerlink" href="#install-the-dependencies" title="Permalink to this headline"></a></h3>
<p>If you want to directly use <code class="docutils literal notranslate"><span class="pre">minos</span></code> without the command-line utility, the following command will install the needed packages:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>pip install <span class="se">\</span>
  minos-microservice-aggregate <span class="se">\</span>
  minos-microservice-common <span class="se">\</span>
  minos-microservice-cqrs <span class="se">\</span>
  minos-microservice-networks <span class="se">\</span>
  minos-microservice-saga
  minos-broker-kafka <span class="se">\</span>
  minos-http-aiohttp
</pre></div>
</div>
</section>
<section id="configure-a-microservice">
<h3>Configure a Microservice<a class="headerlink" href="#configure-a-microservice" title="Permalink to this headline"></a></h3>
<p>To keep things simpler, this quickstart will create a microservice assuming all the source code is stored on a single <code class="docutils literal notranslate"><span class="pre">foo/main.py</span></code> file. In addition to the source file, a <code class="docutils literal notranslate"><span class="pre">foo/config.yml</span></code> will contain all the configuration stuff.</p>
<p>The directory structure will become:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>.
└── foo
    ├── config.yml
    └── main.py
</pre></div>
</div>
<p>Create a <code class="docutils literal notranslate"><span class="pre">foo/config.yml</span></code> file and add the following lines:</p>
<details>
  <summary>Click to show the full file</summary>

```yaml
# foo/config.yml

version: 2
name: foo
aggregate:
  entities:
    - main.Foo
  repositories:
    transaction: minos.aggregate.PostgreSqlTransactionRepository
    event: minos.aggregate.PostgreSqlEventRepository
    snapshot: minos.aggregate.PostgreSqlSnapshotRepository
databases:
  default:
    database: foo_db
    user: minos
    password: min0s
  saga:
    path: "./foo.lmdb"
interfaces:
  broker:
    port: minos.networks.BrokerPort
    publisher:
      client: minos.plugins.kafka.KafkaBrokerPublisher
      queue: minos.networks.PostgreSqlBrokerPublisherQueue
    subscriber:
      client: minos.plugins.kafka.KafkaBrokerSubscriber
      queue: minos.networks.PostgreSqlBrokerSubscriberQueue
      validator: minos.networks.PostgreSqlBrokerSubscriberDuplicateValidator
  http:
    port: minos.networks.HttpPort
    connector:
      client: minos.plugins.aiohttp.AioHttpConnector
      port: 4545
  periodic:
    port: minos.networks.PeriodicPort
pools:
  lock: minos.common.PostgreSqlLockPool
  databasse: minos.common.PostgreSqlPool
  broker: minos.networks.BrokerClientPool
saga:
  manager: minos.saga.SagaManager
routers:
  - minos.networks.BrokerRouter
  - minos.networks.PeriodicRouter
  - minos.networks.RestHttpRouter
middleware:
  - minos.saga.transactional_command
services:
  - minos.networks.SystemService
  - minos.aggregate.TransactionService
  - minos.aggregate.SnapshotService
  - minos.saga.SagaService
  - main.FooCommandService
  - main.FooQueryService
```

</details><p>Create a <code class="docutils literal notranslate"><span class="pre">foo/main.py</span></code> file and add the following content:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># foo/main.py</span>

<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">minos.aggregate</span> <span class="kn">import</span> <span class="n">Aggregate</span><span class="p">,</span> <span class="n">RootEntity</span>
<span class="kn">from</span> <span class="nn">minos.common</span> <span class="kn">import</span> <span class="n">EntrypointLauncher</span>
<span class="kn">from</span> <span class="nn">minos.cqrs</span> <span class="kn">import</span> <span class="n">CommandService</span><span class="p">,</span> <span class="n">QueryService</span>


<span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="n">RootEntity</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Foo RootEntity class.&quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">FooAggregate</span><span class="p">(</span><span class="n">Aggregate</span><span class="p">[</span><span class="n">Foo</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;Foo Aggregate class.&quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">FooCommandService</span><span class="p">(</span><span class="n">CommandService</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Foo Command Service class.&quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">FooQueryService</span><span class="p">(</span><span class="n">QueryService</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Foo Query Service class.&quot;&quot;&quot;</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">launcher</span> <span class="o">=</span> <span class="n">EntrypointLauncher</span><span class="o">.</span><span class="n">from_config</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;config.yml&quot;</span><span class="p">)</span>
    <span class="n">launcher</span><span class="o">.</span><span class="n">launch</span><span class="p">()</span>
</pre></div>
</div>
<p>Execute the following command to start the microservice:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>python foo/main.py
</pre></div>
</div>
</section>
<section id="create-an-aggregate">
<h3>Create an Aggregate<a class="headerlink" href="#create-an-aggregate" title="Permalink to this headline"></a></h3>
<p>The way to model data in <code class="docutils literal notranslate"><span class="pre">minos</span></code> is highly inspired by the  <a class="reference external" href="https://microservices.io/patterns/data/event-sourcing.html">Event Sourcing</a> ideas. For this reason, the classes to be used to model data are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">minos.aggregate.Entity</span></code>: A model that has an identifier that gives it a unique identity, in the sense that some values from which it is composed could change, but its identity will continue being the same.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">minos.aggregate.ExternalEntity</span></code>: A model that belongs to another microservice (or aggregate boundary) but needs to be used for some reason inside this microservice (or aggregate boundary).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">minos.aggregate.RootEntity</span></code>: Is an <code class="docutils literal notranslate"><span class="pre">Entity</span></code> superset that provides global identity across the project compared to standard <code class="docutils literal notranslate"><span class="pre">Entity</span></code> models, that has only local identity (the <code class="docutils literal notranslate"><span class="pre">RootEntity</span></code> can be accessed from another microservices as <code class="docutils literal notranslate"><span class="pre">ExternalEntity</span></code> models, but standard <code class="docutils literal notranslate"><span class="pre">Entity</span></code> models can only be accessed within the microservice that define them). The <code class="docutils literal notranslate"><span class="pre">RootEntity</span></code> is also the one that interacts with the persistence layer (the <code class="docutils literal notranslate"><span class="pre">EventRepository</span></code> and <code class="docutils literal notranslate"><span class="pre">SnapshotRepository</span></code> instances).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">minos.aggregate.Ref</span></code>: A wrapper class that provides the functionality to store a reference of other <code class="docutils literal notranslate"><span class="pre">RootEntity</span></code> or <code class="docutils literal notranslate"><span class="pre">ExternalEntity</span></code> instances.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">minos.aggregate.EntitySet</span></code>: A container of <code class="docutils literal notranslate"><span class="pre">Entity</span></code> instances that takes advantage of the incremental behaviour of the <code class="docutils literal notranslate"><span class="pre">EventRepository</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">minos.aggregate.ValueObject</span></code>: A model that is only identified by the values that compose it, so that if some of them changes, then the model becomes completely different (for that reason, these models are immutable).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">minos.aggregate.ValueObjectSet</span></code>: A container of <code class="docutils literal notranslate"><span class="pre">ValueObject</span></code> instances that takes advantage of the incremental behaviour of the <a href="#id2"><span class="problematic" id="id3">`</span></a>EventRepository.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">minos.aggregate.Aggregate</span></code>: A collection of <code class="docutils literal notranslate"><span class="pre">Entity</span></code> and/or <code class="docutils literal notranslate"><span class="pre">ValueObject</span></code> models that are related to each other through a <code class="docutils literal notranslate"><span class="pre">RootEntity</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">minos.aggregate.Event</span></code>: A model that contains the difference between the a <code class="docutils literal notranslate"><span class="pre">RootEntity</span></code> instance and its previous version (if any).</p></li>
</ul>
<p>Here is an example of the creation the <code class="docutils literal notranslate"><span class="pre">Foo</span></code> aggregate. In this case, it has two attributes, a <code class="docutils literal notranslate"><span class="pre">bar</span></code> being a <code class="docutils literal notranslate"><span class="pre">str</span></code>, and a <code class="docutils literal notranslate"><span class="pre">foobar</span></code> being an optional reference to the external <code class="docutils literal notranslate"><span class="pre">FooBar</span></code> aggregate, which it is assumed that it has a <code class="docutils literal notranslate"><span class="pre">something</span></code> attribute.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># foo/main.py</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">uuid</span> <span class="kn">import</span> <span class="n">UUID</span>
<span class="kn">from</span> <span class="nn">minos.aggregate</span> <span class="kn">import</span> <span class="n">Aggregate</span><span class="p">,</span> <span class="n">RootEntity</span><span class="p">,</span> <span class="n">ExternalEntity</span><span class="p">,</span> <span class="n">Ref</span>


<span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="n">RootEntity</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Foo RootEntity class.&quot;&quot;&quot;</span>

    <span class="n">bar</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">foobar</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Ref</span><span class="p">[</span><span class="n">FooBar</span><span class="p">]]</span>


<span class="k">class</span> <span class="nc">FooBar</span><span class="p">(</span><span class="n">ExternalEntity</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;FooBar ExternalEntity clas.&quot;&quot;&quot;</span>

    <span class="n">something</span><span class="p">:</span> <span class="nb">str</span>


<span class="k">class</span> <span class="nc">FooAggregate</span><span class="p">(</span><span class="n">Aggregate</span><span class="p">[</span><span class="n">Foo</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;Foo Aggregate class.&quot;&quot;&quot;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">create_foo</span><span class="p">(</span><span class="n">bar</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">UUID</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create a new Foo instance</span>

<span class="sd">        :param bar: The bar of the new instance.</span>
<span class="sd">        :return: The identifier of the new instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">foo</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Foo</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">bar</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">foo</span><span class="o">.</span><span class="n">uuid</span>

    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">update_foobar</span><span class="p">(</span><span class="n">uuid</span><span class="p">:</span> <span class="n">UUID</span><span class="p">,</span> <span class="n">foobar</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Ref</span><span class="p">[</span><span class="n">FooBar</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Update the foobar attribute of the ``Foo`` instance.</span>

<span class="sd">        :param uuid: The identifier of the ``Foo`` instance.</span>
<span class="sd">        :param foobar: The foobar value to be set.</span>
<span class="sd">        :return: This method does not return anything.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">foo</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Foo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">uuid</span><span class="p">)</span>
        <span class="n">foo</span><span class="o">.</span><span class="n">foobar</span> <span class="o">=</span> <span class="n">foobar</span>
        <span class="k">await</span> <span class="n">foo</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
<details>
  <summary>Click to show the full file</summary>

```python
# foo/main.py

from __future__ import annotations

from pathlib import Path
from typing import Optional
from uuid import UUID

from minos.aggregate import Aggregate, RootEntity, ExternalEntity, Ref
from minos.common import EntrypointLauncher
from minos.cqrs import CommandService, QueryService


class Foo(RootEntity):
    """Foo RootEntity class."""

    bar: str
    foobar: Optional[Ref[FooBar]]


class FooBar(ExternalEntity):
    """FooBar ExternalEntity clas."""

    something: str


class FooAggregate(Aggregate[Foo]):
    """Foo Aggregate class."""

    @staticmethod
    async def create_foo(bar: str) -> UUID:
        """Create a new Foo instance

        :param bar: The bar of the new instance.
        :return: The identifier of the new instance.
        """
        foo = await Foo.create(bar)

        return foo.uuid

    @staticmethod
    async def update_foobar(uuid: UUID, foobar: Optional[Ref[FooBar]]) -> None:
        """Update the foobar attribute of the ``Foo`` instance.

        :param uuid: The identifier of the ``Foo`` instance.
        :param foobar: The foobar value to be set.
        :return: This method does not return anything.
        """
        foo = await Foo.get(uuid)
        foo.foobar = foobar
        await foo.save()


class FooCommandService(CommandService):
    """Foo Command Service class."""


class FooQueryService(QueryService):
    """Foo Query Service class."""


if __name__ == '__main__':
    launcher = EntrypointLauncher.from_config(Path(__file__).parent / "config.yml")
    launcher.launch()
```

</details></section>
<section id="expose-a-command">
<h3>Expose a Command<a class="headerlink" href="#expose-a-command" title="Permalink to this headline"></a></h3>
<p>Here is an example of the definition of a command to create <code class="docutils literal notranslate"><span class="pre">Foo</span></code> instances. To do that, it is necessary to define a <code class="docutils literal notranslate"><span class="pre">CommandService</span></code> that contains the handling function. It will handle both the broker messages sent to the <code class="docutils literal notranslate"><span class="pre">&quot;CreateFoo&quot;</span></code> topic and the rest calls to the <code class="docutils literal notranslate"><span class="pre">&quot;/foos&quot;</span></code> path with the <code class="docutils literal notranslate"><span class="pre">&quot;POST&quot;</span></code> method. In this case, the handling function unpacks the <code class="docutils literal notranslate"><span class="pre">Request</span></code>‘s content and then calls the <code class="docutils literal notranslate"><span class="pre">create</span></code> method from the <code class="docutils literal notranslate"><span class="pre">Aggregate</span></code>, which stores the <code class="docutils literal notranslate"><span class="pre">Foo</span></code> instance following an event-driven strategy (it also publishes the <code class="docutils literal notranslate"><span class="pre">&quot;FooCreated&quot;</span></code> event). Finally, a <code class="docutils literal notranslate"><span class="pre">Response</span></code> is returned to be handled by the external caller (another microservice or the API-gateway).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># foo/main.py</span>

<span class="kn">from</span> <span class="nn">minos.cqrs</span> <span class="kn">import</span> <span class="n">CommandService</span>
<span class="kn">from</span> <span class="nn">minos.networks</span> <span class="kn">import</span> <span class="n">enroute</span><span class="p">,</span> <span class="n">Request</span><span class="p">,</span> <span class="n">Response</span>


<span class="k">class</span> <span class="nc">FooCommandService</span><span class="p">(</span><span class="n">CommandService</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Foo Command Service class.&quot;&quot;&quot;</span>

    <span class="nd">@enroute</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s2">&quot;CreateFoo&quot;</span><span class="p">)</span>
    <span class="nd">@enroute</span><span class="o">.</span><span class="n">rest</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s2">&quot;/foos&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">create_foo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create a new Foo.</span>

<span class="sd">        :param request: The ``Request`` that contains the ``bar`` attribute.</span>
<span class="sd">        :return: A ``Response`` containing identifier of the already created instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">content</span> <span class="o">=</span> <span class="k">await</span> <span class="n">request</span><span class="o">.</span><span class="n">content</span><span class="p">()</span>
        <span class="n">bar</span> <span class="o">=</span> <span class="n">content</span><span class="p">[</span><span class="s2">&quot;bar&quot;</span><span class="p">]</span>

        <span class="n">uuid</span> <span class="o">=</span> <span class="k">await</span> <span class="n">FooAggregate</span><span class="o">.</span><span class="n">create_foo</span><span class="p">(</span><span class="n">bar</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Response</span><span class="p">({</span><span class="s2">&quot;uuid&quot;</span><span class="p">:</span> <span class="n">uuid</span><span class="p">})</span>
</pre></div>
</div>
<details>
  <summary>Click to show the full file</summary>

```python
# foo/main.py

from __future__ import annotations

from pathlib import Path
from typing import Optional
from uuid import UUID

from minos.aggregate import Aggregate, RootEntity, ExternalEntity, Ref
from minos.common import EntrypointLauncher
from minos.cqrs import CommandService, QueryService
from minos.networks import Request, Response, enroute


class Foo(RootEntity):
    """Foo RootEntity class."""

    bar: str
    foobar: Optional[Ref[FooBar]]


class FooBar(ExternalEntity):
    """FooBar ExternalEntity clas."""

    something: str


class FooAggregate(Aggregate[Foo]):
    """Foo Aggregate class."""

    @staticmethod
    async def create_foo(bar: str) -> UUID:
        """Create a new Foo instance

        :param bar: The bar of the new instance.
        :return: The identifier of the new instance.
        """
        foo = await Foo.create(bar)

        return foo.uuid

    @staticmethod
    async def update_foobar(uuid: UUID, foobar: Optional[Ref[FooBar]]) -> None:
        """Update the foobar attribute of the ``Foo`` instance.

        :param uuid: The identifier of the ``Foo`` instance.
        :param foobar: The foobar value to be set.
        :return: This method does not return anything.
        """
        foo = await Foo.get(uuid)
        foo.foobar = foobar
        await foo.save()


class FooCommandService(CommandService):
    """Foo Command Service class."""

    @enroute.broker.command("CreateFoo")
    @enroute.rest.command("/foos", "POST")
    async def create_foo(self, request: Request) -> Response:
        """Create a new Foo.

        :param request: The ``Request`` that contains the ``bar`` attribute.
        :return: A ``Response`` containing identifier of the already created instance.
        """
        content = await request.content()
        bar = content["bar"]

        uuid = await FooAggregate.create_foo(bar)

        return Response({"uuid": uuid})


class FooQueryService(QueryService):
    """Foo Query Service class."""


if __name__ == '__main__':
    launcher = EntrypointLauncher.from_config(Path(__file__).parent / "config.yml")
    launcher.launch()
```

</details><p>Execute the following command to start the microservice:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>python foo/main.py
</pre></div>
</div>
<p>To check that everything works fine, execute the following command:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>curl --location --request POST <span class="s1">&#39;http://localhost:4545/foos&#39;</span> <span class="se">\</span>
--header <span class="s1">&#39;Content-Type: application/json&#39;</span> <span class="se">\</span>
--data-raw <span class="s1">&#39;{</span>
<span class="s1">    &quot;bar&quot;: &quot;test&quot;</span>
<span class="s1">}&#39;</span>
</pre></div>
</div>
<p>And the expected response will be similar to:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="nt">&quot;uuid&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;YOUR_UUID&quot;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="subscribe-to-an-event-and-expose-a-query">
<h3>Subscribe to an Event and Expose a Query<a class="headerlink" href="#subscribe-to-an-event-and-expose-a-query" title="Permalink to this headline"></a></h3>
<p>Here is an example of the event and query handling. In this case, it must be defined on a <code class="docutils literal notranslate"><span class="pre">QueryService</span></code> class. In this case a <code class="docutils literal notranslate"><span class="pre">&quot;FooCreated&quot;</span></code> and <code class="docutils literal notranslate"><span class="pre">&quot;FooUpdated.foobar&quot;</span></code> events are handled (they will print the content on the microservice’s logs). The event contents typically contains instances of <code class="docutils literal notranslate"><span class="pre">AggregateDiff</span></code> type, which is referred to the difference respect to the previously stored instance. The exposed query is connected to the calls that come from the <code class="docutils literal notranslate"><span class="pre">&quot;/foos/example&quot;</span></code> path and <code class="docutils literal notranslate"><span class="pre">&quot;GET&quot;</span></code> method and a naive string is returned.</p>
<p><em>Disclaimer</em>: A real <code class="docutils literal notranslate"><span class="pre">QueryService</span></code> implementation must populate a query-oriented database based on the events to which is subscribed to, and expose queries performed over that query-oriented database.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># foo/main.py</span>

<span class="kn">from</span> <span class="nn">minos.cqrs</span> <span class="kn">import</span> <span class="n">QueryService</span>
<span class="kn">from</span> <span class="nn">minos.networks</span> <span class="kn">import</span> <span class="n">enroute</span><span class="p">,</span> <span class="n">Request</span><span class="p">,</span> <span class="n">Response</span>


<span class="k">class</span> <span class="nc">FooQueryService</span><span class="p">(</span><span class="n">QueryService</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Foo Query Service class.&quot;&quot;&quot;</span>

    <span class="nd">@enroute</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="s2">&quot;FooCreated&quot;</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">foo_created</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Handle the &quot;FooCreated&quot; event.</span>

<span class="sd">        :param request: The ``Request`` that contains a ``Event``.</span>
<span class="sd">        :return: This method does not return anything.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">event</span> <span class="o">=</span> <span class="k">await</span> <span class="n">request</span><span class="o">.</span><span class="n">content</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;A Foo was created: </span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nd">@enroute</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="s2">&quot;FooUpdated.foobar&quot;</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">foo_foobar_updated</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Handle the &quot;FooUpdated.foobar&quot; event.</span>

<span class="sd">        :param request: The ``Request`` that contains a ``Event``.</span>
<span class="sd">        :return: This method does not return anything.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">event</span> <span class="o">=</span> <span class="k">await</span> <span class="n">request</span><span class="o">.</span><span class="n">content</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The &#39;foobar&#39; field of a Foo was updated: </span><span class="si">{</span><span class="n">event</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nd">@enroute</span><span class="o">.</span><span class="n">rest</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;/foos/example&quot;</span><span class="p">,</span> <span class="s2">&quot;GET&quot;</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">example</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Handle the example query.</span>

<span class="sd">        :param request: The ``Request`` that contains the necessary information.</span>
<span class="sd">        :return: A ``Response`` instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s2">&quot;This is an example response!&quot;</span><span class="p">)</span>
</pre></div>
</div>
<details>
  <summary>Click to show the full file</summary>

```python
# foo/main.py

from __future__ import annotations

from pathlib import Path
from typing import Optional
from uuid import UUID

from minos.aggregate import Aggregate, RootEntity, ExternalEntity, Ref
from minos.common import EntrypointLauncher
from minos.cqrs import CommandService, QueryService
from minos.networks import Request, Response, enroute


class Foo(RootEntity):
    """Foo RootEntity class."""

    bar: str
    foobar: Optional[Ref[FooBar]]


class FooBar(ExternalEntity):
    """FooBar ExternalEntity clas."""

    something: str


class FooAggregate(Aggregate[Foo]):
    """Foo Aggregate class."""

    @staticmethod
    async def create_foo(bar: str) -> UUID:
        """Create a new Foo instance

        :param bar: The bar of the new instance.
        :return: The identifier of the new instance.
        """
        foo = await Foo.create(bar)

        return foo.uuid

    @staticmethod
    async def update_foobar(uuid: UUID, foobar: Optional[Ref[FooBar]]) -> None:
        """Update the foobar attribute of the ``Foo`` instance.

        :param uuid: The identifier of the ``Foo`` instance.
        :param foobar: The foobar value to be set.
        :return: This method does not return anything.
        """
        foo = await Foo.get(uuid)
        foo.foobar = foobar
        await foo.save()


class FooCommandService(CommandService):
    """Foo Command Service class."""

    @enroute.broker.command("CreateFoo")
    @enroute.rest.command("/foos", "POST")
    async def create_foo(self, request: Request) -> Response:
        """Create a new Foo.

        :param request: The ``Request`` that contains the ``bar`` attribute.
        :return: A ``Response`` containing identifier of the already created instance.
        """
        content = await request.content()
        bar = content["bar"]

        uuid = await FooAggregate.create_foo(bar)

        return Response({"uuid": uuid})


class FooQueryService(QueryService):
    """Foo Query Service class."""

    @enroute.broker.event("FooCreated")
    async def foo_created(self, request: Request) -> None:
        """Handle the "FooCreated" event.

        :param request: The ``Request`` that contains a ``Event``.
        :return: This method does not return anything.
        """
        event = await request.content()
        print(f"A Foo was created: {event}")

    @enroute.broker.event("FooUpdated.foobar")
    async def foo_foobar_updated(self, request: Request) -> None:
        """Handle the "FooUpdated.foobar" event.

        :param request: The ``Request`` that contains a ``Event``.
        :return: This method does not return anything.
        """
        event = await request.content()
        print(f"The 'foobar' field of a Foo was updated: {event}")

    @enroute.rest.query("/foos/example", "GET")
    async def example(self, request: Request) -> Response:
        """Handle the example query.

        :param request: The ``Request`` that contains the necessary information.
        :return: A ``Response`` instance.
        """
        return Response("This is an example response!")


if __name__ == '__main__':
    launcher = EntrypointLauncher.from_config(Path(__file__).parent / "config.yml")
    launcher.launch()
```

</details><p>Execute the following command to start the microservice:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>python foo/main.py
</pre></div>
</div>
<p>Now, if a new instance is created (with a rest call, like in the <a class="reference external" href="#expose-a-command">previous section</a>), the <code class="docutils literal notranslate"><span class="pre">FooCreated</span></code> event will be handled and the microservice’s console will print something like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">A</span> <span class="n">Foo</span> <span class="n">was</span> <span class="n">created</span><span class="p">:</span> <span class="n">Event</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
<p>Also, to check that everything is fine the example query can be executed with:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>curl --location --request GET <span class="s1">&#39;http://localhost:4545/foos/example&#39;</span>
</pre></div>
</div>
<p>And the expected result should be something like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;This is an example response!&quot;</span>
</pre></div>
</div>
</section>
<section id="interact-with-another-microservice">
<h3>Interact with another Microservice<a class="headerlink" href="#interact-with-another-microservice" title="Permalink to this headline"></a></h3>
<p>Here is an example of the interaction between two microservices through a SAGA pattern. In this case, the interaction starts with a call to the <code class="docutils literal notranslate"><span class="pre">&quot;/foos/add-foobar&quot;</span></code> path and the <code class="docutils literal notranslate"><span class="pre">&quot;POST&quot;</span></code> method, which performs a <code class="docutils literal notranslate"><span class="pre">SagaManager</span></code> run over the <code class="docutils literal notranslate"><span class="pre">ADD_FOOBAR_SAGA</span></code> saga. This saga has two steps, one remote that executes the <code class="docutils literal notranslate"><span class="pre">&quot;CreateFooBar&quot;</span></code> command (possibly defined on the supposed <code class="docutils literal notranslate"><span class="pre">&quot;foobar&quot;</span></code> microservice), and a local step that is executed on this microservice. The <code class="docutils literal notranslate"><span class="pre">CreateFooBarDTO</span></code> defines the structure of the request to be sent when the <code class="docutils literal notranslate"><span class="pre">&quot;CreateFooBar&quot;</span></code> command is executed.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># foo/main.py</span>

<span class="kn">from</span> <span class="nn">minos.common</span> <span class="kn">import</span> <span class="n">ModelType</span>
<span class="kn">from</span> <span class="nn">minos.cqrs</span> <span class="kn">import</span> <span class="n">CommandService</span>
<span class="kn">from</span> <span class="nn">minos.networks</span> <span class="kn">import</span> <span class="n">enroute</span><span class="p">,</span> <span class="n">Request</span>
<span class="kn">from</span> <span class="nn">minos.saga</span> <span class="kn">import</span> <span class="n">Saga</span><span class="p">,</span> <span class="n">SagaContext</span><span class="p">,</span> <span class="n">SagaRequest</span><span class="p">,</span> <span class="n">SagaResponse</span>


<span class="k">class</span> <span class="nc">FooCommandService</span><span class="p">(</span><span class="n">CommandService</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Foo Command Service class.&quot;&quot;&quot;</span>

    <span class="nd">@enroute</span><span class="o">.</span><span class="n">rest</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s2">&quot;/foos/add-foobar&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">update_foo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Run a saga example.</span>

<span class="sd">        :param request: The ``Request`` that contains the initial saga&#39;s context.</span>
<span class="sd">        :return: This method does not return anything.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">content</span> <span class="o">=</span> <span class="k">await</span> <span class="n">request</span><span class="o">.</span><span class="n">content</span><span class="p">()</span>

        <span class="n">context</span> <span class="o">=</span> <span class="n">SagaContext</span><span class="p">(</span><span class="n">uuid</span><span class="o">=</span><span class="n">content</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">],</span> <span class="n">something</span><span class="o">=</span><span class="n">content</span><span class="p">[</span><span class="s2">&quot;something&quot;</span><span class="p">])</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">saga_manager</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">ADD_FOOBAR_SAGA</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_create_foobar</span><span class="p">(</span><span class="n">context</span><span class="p">:</span> <span class="n">SagaContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SagaRequest</span><span class="p">:</span>
    <span class="n">something</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="s2">&quot;something&quot;</span><span class="p">]</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">CreateFooBarDTO</span><span class="p">(</span><span class="mi">56</span><span class="p">,</span> <span class="n">something</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">SagaRequest</span><span class="p">(</span><span class="s2">&quot;CreateFooBar&quot;</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">_success_foobar</span><span class="p">(</span><span class="n">context</span><span class="p">:</span> <span class="n">SagaContext</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="n">SagaResponse</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SagaContext</span><span class="p">:</span>
    <span class="n">context</span><span class="p">[</span><span class="s2">&quot;foobar_uuid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">context</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">_error_foobar</span><span class="p">(</span><span class="n">context</span><span class="p">:</span> <span class="n">SagaContext</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="n">SagaResponse</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SagaContext</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The foobar could not be created!&quot;</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">_update_foo</span><span class="p">(</span><span class="n">context</span><span class="p">:</span> <span class="n">SagaContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">await</span> <span class="n">FooAggregate</span><span class="o">.</span><span class="n">update_foobar</span><span class="p">(</span><span class="n">context</span><span class="p">[</span><span class="s2">&quot;uuid&quot;</span><span class="p">],</span> <span class="n">context</span><span class="p">[</span><span class="s2">&quot;foobar_uuid&quot;</span><span class="p">])</span>


<span class="n">CreateFooBarDTO</span> <span class="o">=</span> <span class="n">ModelType</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="s2">&quot;AnotherDTO&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;number&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">})</span>

<span class="n">ADD_FOOBAR_SAGA</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">Saga</span><span class="p">()</span>
        <span class="o">.</span><span class="n">remote_step</span><span class="p">()</span>
        <span class="o">.</span><span class="n">on_execute</span><span class="p">(</span><span class="n">_create_foobar</span><span class="p">)</span>
        <span class="o">.</span><span class="n">on_success</span><span class="p">(</span><span class="n">_success_foobar</span><span class="p">)</span>
        <span class="o">.</span><span class="n">on_error</span><span class="p">(</span><span class="n">_error_foobar</span><span class="p">)</span>
        <span class="o">.</span><span class="n">local_step</span><span class="p">()</span>
        <span class="o">.</span><span class="n">on_execute</span><span class="p">(</span><span class="n">_update_foo</span><span class="p">)</span>
        <span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
<details>
  <summary>Click to show the full file</summary>

```python
# foo/main.py

from __future__ import annotations

from pathlib import Path
from typing import Optional
from uuid import UUID

from minos.aggregate import Aggregate, RootEntity, ExternalEntity, Ref
from minos.common import ModelType, EntrypointLauncher
from minos.cqrs import CommandService, QueryService
from minos.networks import Request, Response, enroute
from minos.saga import Saga, SagaContext, SagaRequest, SagaResponse


class Foo(RootEntity):
    """Foo RootEntity class."""

    bar: str
    foobar: Optional[Ref[FooBar]]


class FooBar(ExternalEntity):
    """FooBar ExternalEntity clas."""

    something: str


class FooAggregate(Aggregate[Foo]):
    """Foo Aggregate class."""

    @staticmethod
    async def create_foo(bar: str) -> UUID:
        """Create a new Foo instance

        :param bar: The bar of the new instance.
        :return: The identifier of the new instance.
        """
        foo = await Foo.create(bar)

        return foo.uuid

    @staticmethod
    async def update_foobar(uuid: UUID, foobar: Optional[Ref[FooBar]]) -> None:
        """Update the foobar attribute of the ``Foo`` instance.

        :param uuid: The identifier of the ``Foo`` instance.
        :param foobar: The foobar value to be set.
        :return: This method does not return anything.
        """
        foo = await Foo.get(uuid)
        foo.foobar = foobar
        await foo.save()


class FooCommandService(CommandService):
    """Foo Command Service class."""

    @enroute.broker.command("CreateFoo")
    @enroute.rest.command("/foos", "POST")
    async def create_foo(self, request: Request) -> Response:
        """Create a new Foo.

        :param request: The ``Request`` that contains the ``bar`` attribute.
        :return: A ``Response`` containing identifier of the already created instance.
        """
        content = await request.content()
        bar = content["bar"]

        uuid = await FooAggregate.create_foo(bar)

        return Response({"uuid": uuid})

    @enroute.rest.command("/foos/add-foobar", "POST")
    async def update_foo(self, request: Request) -> None:
        """Run a saga example.

        :param request: The ``Request`` that contains the initial saga's context.
        :return: This method does not return anything.
        """
        content = await request.content()

        context = SagaContext(uuid=content["uuid"], something=content["something"])
        await self.saga_manager.run(ADD_FOOBAR_SAGA, context)


def _create_foobar(context: SagaContext) -> SagaRequest:
    something = context["something"]
    content = CreateFooBarDTO(56, something)
    return SagaRequest("CreateFooBar", content)


async def _success_foobar(context: SagaContext, response: SagaResponse) -> SagaContext:
    context["foobar_uuid"] = await response.content()
    return context


async def _error_foobar(context: SagaContext, response: SagaResponse) -> SagaContext:
    raise ValueError("The foobar could not be created!")


async def _update_foo(context: SagaContext) -> None:
    await FooAggregate.update_foobar(context["uuid"], context["foobar_uuid"])


CreateFooBarDTO = ModelType.build("AnotherDTO", {"number": int, "text": str})

ADD_FOOBAR_SAGA = (
    Saga()
        .remote_step()
        .on_execute(_create_foobar)
        .on_success(_success_foobar)
        .on_error(_error_foobar)
        .local_step()
        .on_execute(_update_foo)
        .commit()
)


class FooQueryService(QueryService):
    """Foo Query Service class."""

    @enroute.broker.event("FooCreated")
    async def foo_created(self, request: Request) -> None:
        """Handle the "FooCreated" event.

        :param request: The ``Request`` that contains a ``Event``.
        :return: This method does not return anything.
        """
        event = await request.content()
        print(f"A Foo was created: {event}")

    @enroute.broker.event("FooUpdated.foobar")
    async def foo_foobar_updated(self, request: Request) -> None:
        """Handle the "FooUpdated.foobar" event.

        :param request: The ``Request`` that contains a ``Event``.
        :return: This method does not return anything.
        """
        event = await request.content()
        print(f"The 'foobar' field of a Foo was updated: {event}")

    @enroute.rest.query("/foos/example", "GET")
    async def example(self, request: Request) -> Response:
        """Handle the example query.

        :param request: The ``Request`` that contains the necessary information.
        :return: A ``Response`` instance.
        """
        return Response("This is an example response!")


if __name__ == '__main__':
    launcher = EntrypointLauncher.from_config(Path(__file__).parent / "config.yml")
    launcher.launch()
```

</details><p>Execute the following command to start the <code class="docutils literal notranslate"><span class="pre">foo</span></code> microservice:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>python foo/main.py
</pre></div>
</div>
<p><strong>Disclaimer</strong>: Note that in this case another microservice is needed to complete the saga.</p>
<section id="the-foobar-microservice">
<h4>The <code class="docutils literal notranslate"><span class="pre">foobar</span></code> Microservice<a class="headerlink" href="#the-foobar-microservice" title="Permalink to this headline"></a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">foobar</span></code> microservice will simply have a <code class="docutils literal notranslate"><span class="pre">CreateFooBar</span></code> command to create new instances of its <code class="docutils literal notranslate"><span class="pre">FooBar</span></code> root entity.</p>
<p>The directory structure will become:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>.
├── foo
│   ├── config.yml
│   └── main.py
└── foobar
    ├── config.yml
    └── main.py
</pre></div>
</div>
<p>Here is the <code class="docutils literal notranslate"><span class="pre">foobar/config.yml</span></code> config file:</p>
<details>
  <summary>Click to show the full file</summary>

```yaml
# foobar/config.yml

version: 2
name: foobar
aggregate:
  entities:
    - main.FooBar
  repositories:
    transaction: minos.aggregate.PostgreSqlTransactionRepository
    event: minos.aggregate.PostgreSqlEventRepository
    snapshot: minos.aggregate.PostgreSqlSnapshotRepository
databases:
  default:
    database: foobar_db
    user: minos
    password: min0s
  saga:
    path: "./foobar.lmdb"
interfaces:
  broker:
    port: minos.networks.BrokerPort
    publisher:
      client: minos.plugins.kafka.KafkaBrokerPublisher
      queue: minos.networks.PostgreSqlBrokerPublisherQueue
    subscriber:
      client: minos.plugins.kafka.KafkaBrokerSubscriber
      queue: minos.networks.PostgreSqlBrokerSubscriberQueue
      validator: minos.networks.PostgreSqlBrokerSubscriberDuplicateValidator
  http:
    port: minos.networks.HttpPort
    connector:
      client: minos.plugins.aiohttp.AioHttpConnector
      port: 4546
  periodic:
    port: minos.networks.PeriodicPort
pools:
  lock: minos.common.PostgreSqlLockPool
  databasse: minos.common.PostgreSqlPool
  broker: minos.networks.BrokerClientPool
saga:
  manager: minos.saga.SagaManager
routers:
  - minos.networks.BrokerRouter
  - minos.networks.PeriodicRouter
  - minos.networks.RestHttpRouter
middleware:
  - minos.saga.transactional_command
services:
  - minos.networks.SystemService
  - minos.aggregate.TransactionService
  - minos.aggregate.SnapshotService
  - minos.saga.SagaService
  - main.FooBarCommandService
```

</details><p>Here is the <code class="docutils literal notranslate"><span class="pre">foobar/main.py</span></code> source file:</p>
<details>
  <summary>Click to show the full file</summary>

```python
from __future__ import annotations

from pathlib import Path
from uuid import UUID

from minos.aggregate import Aggregate, RootEntity
from minos.common import EntrypointLauncher
from minos.cqrs import CommandService
from minos.networks import Request, Response, enroute


class FooBar(RootEntity):
    """FooBar Root Entity clas."""

    something: str


class FooBarAggregate(Aggregate[FooBar]):
    """FooBar Aggregate class."""

    @staticmethod
    async def create_foobar(something: str) -> UUID:
        """Create a new ``FooBar`` instance.

        :param something: The something attribute.
        :return: The identifier of the new instance.
        """
        foobar = await FooBar.create(something)
        return foobar.uuid


class FooBarCommandService(CommandService):
    """Foo Command Service class."""

    @enroute.broker.command("CreateFooBar")
    async def create_foobar(self, request: Request) -> Response:
        """Create a new FooBar.

        :param request: The ``Request`` that contains the ``something`` attribute.
        :return: A ``Response`` containing identifier of the already created instance.
        """
        content = await request.content()
        something = content["text"]

        uuid = await FooBarAggregate.create_foobar(something)

        return Response(uuid)


if __name__ == '__main__':
    launcher = EntrypointLauncher.from_config(Path(__file__).parent / "config.yml")
    launcher.launch()

```

</details><p>Execute the following command to start the <code class="docutils literal notranslate"><span class="pre">foobar</span></code> microservice:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>python foobar/main.py
</pre></div>
</div>
<p>To check that everything works fine, execute the following command:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>curl --location --request POST <span class="s1">&#39;http://localhost:4545/foos/add-foobar&#39;</span> <span class="se">\</span>
--header <span class="s1">&#39;Content-Type: application/json&#39;</span> <span class="se">\</span>
--data-raw <span class="s1">&#39;{</span>
<span class="s1">    &quot;uuid&quot;: &quot;YOUR_UUID&quot;,</span>
<span class="s1">    &quot;something&quot;: &quot;something&quot;</span>
<span class="s1">}&#39;</span>
</pre></div>
</div>
<p>This request will start a new Saga, that sends a command to the <code class="docutils literal notranslate"><span class="pre">foobar</span></code> microservice, retrieve the <code class="docutils literal notranslate"><span class="pre">FooBar</span></code> identifier and update the <code class="docutils literal notranslate"><span class="pre">Foo</span></code> instance. After that, the <code class="docutils literal notranslate"><span class="pre">FooQueryService</span></code> will handle the update event and print a message similar to this one on the console.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">The</span> <span class="s1">&#39;foobar&#39;</span> <span class="n">field</span> <span class="n">of</span> <span class="n">a</span> <span class="n">Foo</span> <span class="n">was</span> <span class="n">updated</span><span class="p">:</span> <span class="n">Event</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="packages">
<h2>Packages<a class="headerlink" href="#packages" title="Permalink to this headline"></a></h2>
<p>This project follows a modular structure based on python packages.</p>
<section id="core">
<h3>Core<a class="headerlink" href="#core" title="Permalink to this headline"></a></h3>
<p>The core packages provide the base implementation of the framework.</p>
<ul class="simple">
<li><p><a class="reference external" href="https://minos-framework.github.io/minos-python/packages/core/minos-microservice-aggregate">minos-microservice-aggregate</a>: The Aggregate pattern implementation.</p></li>
<li><p><a class="reference external" href="https://minos-framework.github.io/minos-python/packages/core/minos-microservice-common">minos-microservice-common</a>: The common core package.</p></li>
<li><p><a class="reference external" href="https://minos-framework.github.io/minos-python/packages/core/minos-microservice-cqrs">minos-microservice-cqrs</a>: The CQRS pattern implementation.</p></li>
<li><p><a class="reference external" href="https://minos-framework.github.io/minos-python/packages/core/minos-microservice-networks">minos-microservice-networks</a>: The networks core package.</p></li>
<li><p><a class="reference external" href="https://minos-framework.github.io/minos-python/packages/core/minos-microservice-saga">minos-microservice-saga</a>: The SAGA pattern implementation.</p></li>
</ul>
</section>
<section id="plugins">
<h3>Plugins<a class="headerlink" href="#plugins" title="Permalink to this headline"></a></h3>
<p>The plugin packages provide connectors to external technologies like brokers, discovery services, databases, serializers and so on.</p>
<ul class="simple">
<li><p><a class="reference external" href="https://minos-framework.github.io/minos-python/packages/plugins/minos-broker-kafka">minos-broker-kafka</a>: The <code class="docutils literal notranslate"><span class="pre">kafka</span></code> plugin package.</p></li>
<li><p><a class="reference external" href="https://minos-framework.github.io/minos-python/packages/plugins/minos-broker-rabbitmq">minos-broker-rabbitmq</a>: The <code class="docutils literal notranslate"><span class="pre">rabbitmq</span></code> plugin package.</p></li>
<li><p><a class="reference external" href="https://minos-framework.github.io/minos-python/packages/plugins/minos-discovery-minos">minos-discovery-minos</a>: The <code class="docutils literal notranslate"><span class="pre">minos-discovery</span></code> plugin package.</p></li>
<li><p><a class="reference external" href="https://minos-framework.github.io/minos-python/packages/plugins/minos-http-aiohttp">minos-http-aiohttp</a>: The <code class="docutils literal notranslate"><span class="pre">aiohttp</span></code> plugin package.</p></li>
<li><p><a class="reference external" href="https://minos-framework.github.io/minos-python/packages/plugins/minos-router-graphql">minos-router-graphql</a>: The <code class="docutils literal notranslate"><span class="pre">grapqhl</span></code> plugin package.</p></li>
</ul>
</section>
</section>
<section id="source-code">
<h2>Source Code<a class="headerlink" href="#source-code" title="Permalink to this headline"></a></h2>
<p>The source code of this project is hosted at this <a class="reference external" href="https://github.com/minos-framework/minos-python">GitHub Repository</a>.</p>
</section>
<section id="getting-help">
<h2>Getting Help<a class="headerlink" href="#getting-help" title="Permalink to this headline"></a></h2>
<p>For usage questions, the best place to go to is <a class="reference external" href="https://stackoverflow.com/questions/tagged/minos">StackOverflow</a>.</p>
</section>
<section id="discussion-and-development">
<h2>Discussion and Development<a class="headerlink" href="#discussion-and-development" title="Permalink to this headline"></a></h2>
<p>Most development discussions take place over this <a class="reference external" href="https://github.com/minos-framework/minos-python/issues">GitHub Issues</a>. In addition, a <a class="reference external" href="https://gitter.im/minos-framework/community">Gitter channel</a> is available for development-related questions.</p>
</section>
<section id="how-to-contribute">
<h2>How to contribute<a class="headerlink" href="#how-to-contribute" title="Permalink to this headline"></a></h2>
<p>We are looking forward to having your contributions. No matter whether it is a pull request with new features, or the creation of an issue related to a bug you have found.</p>
<p>Please consider these guidelines before you submit any modification.</p>
<section id="create-an-issue">
<h3>Create an issue<a class="headerlink" href="#create-an-issue" title="Permalink to this headline"></a></h3>
<ol class="arabic simple">
<li><p>If you happen to find a bug, please file a new issue filling the ‘Bug report’ template.</p></li>
<li><p>Set the appropriate labels, so we can categorise it easily.</p></li>
<li><p>Wait for any core developer’s feedback on it.</p></li>
</ol>
</section>
<section id="submit-a-pull-request">
<h3>Submit a Pull Request<a class="headerlink" href="#submit-a-pull-request" title="Permalink to this headline"></a></h3>
<ol class="arabic simple">
<li><p>Create an issue following the previous steps.</p></li>
<li><p>Fork the project.</p></li>
<li><p>Push your changes to a local branch.</p></li>
<li><p>Run the tests!</p></li>
<li><p>Submit a pull request from your fork’s branch.</p></li>
</ol>
</section>
</section>
<section id="license">
<h2>License<a class="headerlink" href="#license" title="Permalink to this headline"></a></h2>
<p>This project is distributed under the <a class="reference external" href="https://raw.githubusercontent.com/minos-framework/minos-python/main/LICENSE">MIT</a> license.</p>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Clariteia.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>